/*
Malware Protection Plan for GuardDuty (Production-style)

Use case:
- Scan user-uploaded content for malware
- Apply only on sensitive upload buckets
- Automatically tag infected objects
- Allow automation (Lambda / EventBridge) to quarantine or delete

This is typically used for:
- File upload portals
- Document sharing apps
- CI/CD artifact buckets
- Partner file ingestion pipelines
*/

resource "aws_guardduty_malware_protection_plan" "s3_upload_scan" {
  /*
  IAM role that allows GuardDuty to:
  - Read S3 objects
  - Scan files
  - Add malware result tags
  - Write logs

  This role must have:
  - s3:GetObject
  - s3:PutObjectTagging
  - s3:GetObjectTagging
  - logs permissions
  */
  role = aws_iam_role.guardduty_malware_scan_role.arn


  /*
  Define what resources are protected.
  We normally protect:
  - User upload buckets
  - External file ingestion buckets
  - Any bucket receiving untrusted content
  */
  protected_resource {
    s3_bucket {
      /*
      Bucket where users or systems upload files.
      This should be a "hot zone" bucket.
      */
      bucket_name = aws_s3_bucket.upload_bucket.id

      /*
      Only scan these folders (prefixes).
      This avoids scanning logs, backups, or internal artifacts.

      Example real prefixes:
      - "uploads/"
      - "incoming/"
      - "attachments/"
      */
      object_prefixes = [
        "uploads/",
        "incoming/"
      ]
    }
  }

  /*
  Define automated actions GuardDuty performs
  after scanning.
  */
  actions {
    tagging {
      /*
      When malware is detected:
      - Tag the object automatically
      - Enables automation workflows

      Example tag added by AWS:
      MalwareScanStatus = INFECTED
      */
      status = "ENABLED"
    }
  }

  /*
  Normal resource tagging for governance,
  cost tracking, and compliance.
  */
  tags = {
    Name       = "guardduty-malware-s3-upload-scan"
    Purpose    = "Scan user uploads for malware"
    ManagedBy  = "Terraform"
    Security   = "High"
    Compliance = "ISO27001"
  }
}

// Upload bucket

resource "aws_s3_bucket" "upload_bucket" {
  bucket = "guardduty-upload-scan-${data.aws_caller_identity.current.account_id}"

  force_destroy = true # fine for labs, remove in prod

  tags = {
    Name      = "guardduty-upload-bucket"
    Purpose   = "Untrusted file uploads to be scanned by GuardDuty"
    ManagedBy = "Terraform"
    Security  = "High"
  }
}

resource "aws_s3_bucket_public_access_block" "upload_bucket" {
  bucket = aws_s3_bucket.upload_bucket.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

resource "aws_s3_bucket_server_side_encryption_configuration" "upload_bucket" {
  bucket = aws_s3_bucket.upload_bucket.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}

// IAM role

resource "aws_iam_role" "guardduty_malware_scan_role" {
  name = "guardduty-malware-scan-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "malware-protection-plan.guardduty.amazonaws.com"
        }
        Action = "sts:AssumeRole"
      }
    ]
  })

  tags = {
    Name      = "guardduty-malware-scan-role"
    Purpose   = "Allows GuardDuty to scan S3 objects and tag malware results"
    ManagedBy = "Terraform"
    Security  = "High"
  }
}

// attach the policy that gives GuardDuty permission to read objects and tag them

resource "aws_iam_role_policy" "guardduty_malware_scan_policy" {
  role = aws_iam_role.guardduty_malware_scan_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "s3:GetObject",
          "s3:GetObjectTagging",
          "s3:PutObjectTagging"
        ]
        Resource = "${aws_s3_bucket.upload_bucket.arn}/*"
      },
      {
        Effect = "Allow"
        Action = [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
        ]
        Resource = "*"
      }
    ]
  })
}
